\chapter{Robot dynamics}\label{ch:dynamics}

To develop advance system of control and trajectory planning we need a dynamics representation of the robot, the bound between torques and the robot's motions.

\section{Model exploiting Euler-Lagrange equation}

We can exploit the Euler-Lagrange equation to derive a model fo the robot's dynamics.

\[
	\left(\frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dq}\right)^\trans - \left(\frac{\partial \mathcal{L}}{\partial \q}\right)^\trans = \vect{\xi} \qquad
	\mathcal{L} = \mathcal{T} - \mathcal{U}
\]

where $\mathcal{T}$ is the kinetics energy, $\mathcal{U}$ is the potential energy and $\vect{\xi}$ the generalized forces associated to the vector $\q$.

\subsection{Kinetics energy}

\[ \mathcal{T} = \sum_{i=1}^n (\mathcal{T}_{l_i} + \mathcal{T}_{m_i}) \]

This is the sum of the kinetics contributions of all the robot's links, in particular $\mathcal{T}_{l_i}$ is the contribution from the i-th link and $\mathcal{T}_{m_i}$ from the i-th joint motor.

The contribution for the i-th link are defined as

\begin{equation}
    \mathcal{T}_{l_i} = \frac{1}{2} \int_{V_i}  \dot{\vect{p}}_i^{*\trans} \dot{\vect{p}}_i^* \rho dV \label{eq:link_kinetic}
\end{equation}

where $\dot{\vect{p}}_i^*$ is the speed of a generic point of the link, and it can be expressed as

\begin{equation}
    \dot{\vect{p}}_i^* = \dot{\vect{p}}_{l_i} + \vect{\omega}_i \times \vect{r}_i = \dot{\vect{p}}_{l_i} + \matr{S}(\vect{\omega}_i) \vect{r}_i \label{eq:generic_link_point_speed}
\end{equation}

$\vect{p}_{l_i}$ is the position of the center of mass of the i-th link and $\vect{r}_i$ the vector that define the position of generic point respect the link's center of mass.

\begin{equation}
    \vect{p}_{l_i} = \frac{1}{m_i} \int_{V_i} \vect{p}_i^* \rho dV \label{eq:center_mass}
\end{equation}

Combining \autoref{eq:link_kinetic} and \autoref{eq:generic_link_point_speed} we get

\begin{align*}
	\mathcal{T}_{l_i} &= \frac{1}{2} \int_{V_i}
	\left(\dot{\vect{p}}_{l_i} +\matr{S}(\vect{\omega}_i) \vect{r}_i\right)^\trans
	\left(\dot{\vect{p}}_{l_i} + \matr{S}(\vect{\omega}_i) \vect{r}_i\right) \rho dV \\
	&= \frac{1}{2} \int_{V_i} \left(
	\dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i} +
	\dot{\vect{p}}_{l_i}^\trans \matr{S}(\vect{\omega}_i) \vect{r}_i +
	\vect{r}_i^\trans \matr{S}^\trans(\vect{\omega}_i)  \dot{\vect{p}}_{l_i} +
	\vect{r}_i^\trans \matr{S}^\trans(\vect{\omega}_i) \matr{S}(\vect{\omega}_i) \vect{r}_i
	\right) \rho dV \\
	&=
	\frac{1}{2} \int_{V_i} \dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i} \rho dV +
	\int_{V_i} \dot{\vect{p}}_{l_i}^\trans \matr{S}(\vect{\omega}_i) \vect{r}_i \rho dV +
	\frac{1}{2} \int_{V_i} \vect{r}_i^\trans \matr{S}^\trans(\vect{\omega}_i) \matr{S}(\vect{\omega}_i) \vect{r}_i \rho dV
\end{align*}

We can identify in this equation three contributes:

\paragraph{Translation}

\[
	\frac{1}{2} \int_{V_i} \dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i} \rho dV =
	\frac{1}{2} \dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i} \int_{V_i} \rho dV =
	\frac{1}{2} m_i \dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i}
\]

\paragraph{Mutual}

\[
	\int_{V_i} \dot{\vect{p}}_{l_i}^\trans \matr{S}(\vect{\omega}_i) \vect{r}_i \rho dV =
	\dot{\vect{p}}_{l_i}^\trans \matr{S}(\vect{\omega}_i) \int_{V_i} \vect{r}_i \rho dV =
	\dot{\vect{p}}_{l_i}^\trans \matr{S}(\vect{\omega}_i) \int_{V_i} (\vect{p}_i^* - \vect{p}_{l_i}) \rho dV = 0
\]

Because from \autoref{eq:center_mass} we can notice that

\[
	\int_{V_i} \vect{p}_i^* \rho dV = \vect{p}_{l_i} \int_{V_i} \rho dV
	\implies
	\int_{V_i} (\vect{p}_i^* - \vect{p}_{l_i}) \rho dV = 0
\]

\paragraph{Rotational}

\[
	\frac{1}{2} \int_{V_i} \vect{r}_i^\trans \matr{S}^\trans(\vect{\omega}_i) \matr{S}(\vect{\omega}_i) \vect{r}_i \rho dV =
	\frac{1}{2} \vect{\omega}_i^\trans \left( \int_{V_i} \matr{S}^\trans(\vect{r}_i) \matr{S}(\vect{r}_i) \rho dV \right) \vect{\omega}_i
\]

because of $\matr{S}(\vect{\omega}_i) \vect{r}_i = - \matr{S}(\vect{r}_i)\vect{\omega}_i$.

Let us define

\[ \matr{I}_{l_i} = \int_{V_i} \matr{S}^\trans(\vect{r}_i) \matr{S}(\vect{r}_i) \rho dV \]

and we call it \textbf{inertia tensor}\index{inertia!tensor} referred to the center of mass of the i-th link \underline{expressed in the base frame}.

The \textbf{inertia tensor} is a symmetrical matrix $3 \times 3$ and its components are expressed as

\[
	\matr{I}_{l_i} =
	\begin{bmatrix}
		\int (r_{iy}^2 + r_{iz}^2) \rho dV & - \int r_{ix}r_{iy} \rho dV & - \int r_{ix}r_{iz} \rho dV \\
		* & \int (r_{ix}^2 + r_{iz}^2) \rho dV & - \int r_{iy}r_{iz} \rho dV \\
		* & * & \int (r_{ix}^2 + r_{iy}^2) \rho dV
	\end{bmatrix}
\]

We have to note that the inertia tensor expressed in the base frame is dependent by robot configuration, so it would be better if we can express it in the joint frame.
Exploiting the transformation of the rotation speed $\vect{\omega}$ remembering that $\vect{\omega}_i^i = \matr{R}_i^\trans\vect{\omega}_i$ we can write an equivalent tensor expressed in the joint frame as $\matr{I}_i=\matr{R}_i \matr{I}_i^i \matr{R}_i^\trans$.

So, we can write the rotation contributes of i-th joint as

\[
	\frac{1}{2} \int_{V_i} \vect{r}_i^\trans \matr{S}^\trans(\vect{\omega}_i) \matr{S}(\vect{\omega}_i) \vect{r}_i \rho dV =
	\frac{1}{2} \vect{\omega}_i^\trans \matr{I}_i \vect{\omega}_i =
	\frac{1}{2} \vect{\omega}_i^\trans \matr{R}_i \matr{I}_i^i \matr{R}_i^\trans \vect{\omega}_i
\]


Now we can finally write the contribution of the i-th joint to the kinematics energy as

\[
	\mathcal{T}_{l_i} =
	\frac{1}{2} m_i \dot{\vect{p}}_{l_i}^\trans \dot{\vect{p}}_{l_i} +
	\frac{1}{2} \vect{\omega}_i^\trans \matr{R}_i \matr{I}_i^i \matr{R}_i^\trans \vect{\omega}_i
\]

The velocity can easily write as

\[
	\begin{bmatrix}
		\dot{\vect{p}}_{l_i} \\
		\vect{\omega}_i
	\end{bmatrix} =
	\begin{bmatrix}
		\matr{J}_P^{(l_i)} \\
		\matr{J}_O^{(l_i)}
	\end{bmatrix} \dq =
	\matr{J}^{(l_i)} \dq
\]

\begin{nb}$\matr{J}^{(l_i)}$ for a link $i$ include only the contribution of the joints $1, \dots, i$, so the column $i+1,\dots,n$ are equal to $\vect{0}$\end{nb}

\[
	\mathcal{T}_{l_i} =
	\frac{1}{2} m_i \dq^\trans \matr{J}_P^{(l_i)\trans} \matr{J}_P^{(l_i)} \dq +
	\frac{1}{2} \dq^\trans \matr{J}_O^{(l_i)\trans} \matr{R}_i \matr{I}_i^i \matr{R}_i^\trans \matr{J}_O^{(l_i)} \dq
\]

Now we can compute the sum for the kinetics energy (we consider $\mathcal{T}_{m_i} = 0$ for each motor for simplicity, but include motors contributions is an easy task)

\[
	\mathcal{T} =
	\sum_{i=1}^n \mathcal{T}_{l_i} =
	\frac{1}{2} \dq^\trans \matr{B}(\q) \dq =
	\frac{1}{2} \sum_{i=1}^n \sum_{j=1}^n \dot{q}_i \dot{q}_j b_{ij}(\q)
\]

where $\matr{B}(\q)$ is called \textbf{inertia matrix}\index{inertia!matrix} and it is defined as

\[
	\matr{B}(\q) = \sum_{i=1}^n \left(
	m_i \matr{J}_P^{(l_i)\trans} \matr{J}_P^{(l_i)} +
	\matr{J}_O^{(l_i)\trans} \matr{R}_i \matr{I}_i^i \matr{R}_i^\trans \matr{J}_O^{(l_i)}
	\right)
\]

it is symmetrical, $> 0$ and it depends upon the robot configuration $\q$

\subsection{Potential energy}

Also for the potential energy we compute the total energy as the sum of the contribution of each link

\[
	\mathcal{U} = \sum_{i=1}^n \mathcal{U}_i
\]

The potential energy for a link is given by the gravitational force in accordig to this formula

\[
	\mathcal{U}_i = - \int_{V_i} \vect{g}_0^\trans \vect{p}_i^* \rho dV =
	- m_i \vect{g}_0^\trans \vect{p}_i
\]

where $\vect{g}_0$ is the gravity acceleration vector expressed in the base frame.

\[
	\mathcal{U} = - \sum_{i=1}^n m_i \vect{g}_0^\trans \vect{p}_i
\]

\subsection{The Lagrangian}

Now, we have $\mathcal{T}$ and $\mathcal{U}$, so we can finally compute the Lagrangian function and solve the Lagrangian equation

\[
	\mathcal{L}(\q,\dq) = \mathcal{T}(\q,\dq) - \mathcal{U}(\q) =
	\frac{1}{2} \dq^\trans \matr{B}(\q) \dq + \sum_{i=1}^n m_i \vect{g}_0^\trans \vect{p}_i =
	\frac{1}{2} \sum_{i=1}^n \sum_{j=1}^n \dot{q}_i \dot{q}_j b_{ij}(\q) + \sum_{i=1}^n m_i \vect{g}_0^\trans \vect{p}_i(\q)
\]

Let us consider the Lagrangian equation referring to a generic joint

\begin{gather}
    \frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dot{q}_i} - \frac{\partial \mathcal{L}}{\partial q_i} = \xi_i  \nonumber \\
    \frac{d}{dt}\frac{\partial \mathcal{T}(\q,\dq)}{\partial \dot{q}_i} -
    \frac{\partial \mathcal{T}(\q,\dq)}{\partial q_i} +
    \frac{\partial \mathcal{U}(\q)}{\partial q_i} = \xi_i \label{eq:lagrange-kinetics-potential}
\end{gather}

Let us solve the three parts that compose the Lagrangian equation

\begin{align*}
    \frac{d}{dt}\frac{\partial \mathcal{T}(\q,\dq)}{\partial \dot{q}_i}
    &= \frac{d}{dt}\frac{\partial}{\partial \dot{q}_i} \left( \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k b_{jk}(\q) \right) \\
    &= \frac{d}{dt} \left( \sum_{j=1}^n \dot{q}_j b_{ij}(\q) \right) \\
    &= \sum_{j=1}^n \ddot{q}_j b_{ij}(\q) + \sum_{j=1}^n \dot{q}_j \frac{d b_{ij}(\q)}{dt} \\
	&= \sum_{j=1}^n \ddot{q}_j b_{ij}(\q) + \sum_{j=1}^n \dot{q}_j \sum_{k=1}^n \dot{q}_k \frac{\partial b_{ij}(\q)}{\partial q_k}
\end{align*}

\begin{align*}
	\frac{\partial \mathcal{T}(\q,\dq)}{\partial q_i}
	&= \frac{\partial}{\partial q_i} \left( \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k b_{jk}(\q) \right) \\
	&= \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k \frac{\partial b_{jk}(\q)}{\partial q_i}
\end{align*}

\begin{align*}
	\frac{\partial \mathcal{U}(\q)}{\partial q_i}
	&= - \frac{\partial}{\partial q_i} \left(\sum_{j=1}^n m_j \vect{g}_0^\trans \vect{p}_j \right) \\
	&= - \sum_{j=1}^n m_j \vect{g}_0^\trans \frac{\partial \vect{p}_j}{\partial q_i} \\
	&= - \sum_{j=1}^n m_j \vect{g}_0^\trans \vect{J}_{P_i}^{(l_j)}(\q) \\
	&= g_i(\q)
\end{align*}

So the Lagrange equation \ref{eq:lagrange-kinetics-potential} became

\[
	\sum_{j=1}^n \ddot{q}_j b_{ij}(\q) + \sum_{j=1}^n \dot{q}_j \sum_{k=1}^n \dot{q}_k \frac{\partial b_{ij}(\q)}{\partial q_k}
	- \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k \frac{\partial b_{jk}(\q)}{\partial q_i} + g_i(\q) = \xi_i
\]

and if we rearrange the terms we get

\[
	\sum_{j=1}^n \ddot{q}_j b_{ij}(\q) + \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k \left( \frac{\partial b_{ij}(\q)}{\partial q_k} - \frac{1}{2} \frac{\partial b_{jk}(\q)}{\partial q_i} \right) + g_i(\q) = \xi_i
\]

and defined

\[ h_{ijk}(\q) = \frac{\partial b_{ij}(\q)}{\partial q_k} - \frac{1}{2} \frac{\partial b_{jk}(\q)}{\partial q_i} \]

we get the result

\[
	\sum_{j=1}^n \ddot{q}_j b_{ij}(\q) + \sum_{j=1}^n \sum_{k=1}^n \dot{q}_j \dot{q}_k h_{ijk}(\q) + g_i(\q) = \xi_i
\]

where we can recognize

\begin{conditions}
	b_{ii} & inertial moment as "seen" from the axis of the i-th joint \\
	b_{ij} & effect of the acceleration of j-th joint on the i-th joint \\
	h_{ijj}\dot{q}_j^2 & centrifugal effect induced at i-th joint by the velocity of the j-th joint \\
	h_{ijk}\dot{q}_j\dot{q}_k & Coriolis effect induced at i-th joint by the velocity of the joints j and k
\end{conditions}

Now, we can write the Lagrangian equations for all the joints in a matrix form as

\begin{equation}
    \matr{B}(\q)\ddq + \matr{C}(\q,\dq)\dq + \vect{g}(\q) = \vect{\xi} \label{eq:dynamics-generalized-forces}
\end{equation}

\subsubsection{The matrix $\matr{C}$}

The matrix $\matr{C}$ is not unique, and its elements must satisfy the equation

\[
	\sum_{j=1}^n c_{ij} \dot{q}_j = \sum_{j=1}^n \sum_{k=1}^n h_{ijk} \dot{q}_j \dot{q}_k
\]

A possible definition of $\matr{C}$ can be found with this process

\begin{align*}
    \sum_{j=1}^n c_{ij} \dot{q}_j &= \sum_{j=1}^n \sum_{k=1}^n h_{ijk} \dot{q}_j \dot{q}_k \\
    &= \sum_{j=1}^n \sum_{k=1}^n  \dot{q}_j \dot{q}_k \left( \frac{\partial b_{ij}}{\partial q_k} - \frac{1}{2} \frac{\partial b_{jk}}{\partial q_i} \right) \\
    &= \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n  \dot{q}_j \dot{q}_k \left( \frac{\partial b_{ij}}{\partial q_k} \right) +
    \frac{1}{2} \sum_{j=1}^n \sum_{k=1}^n  \dot{q}_j \dot{q}_k \left( \frac{\partial b_{ik}}{\partial q_j} - \frac{\partial b_{jk}}{\partial q_i} \right)
\end{align*}

so the elements of $\matr{C}$ can be defined as

\[
	c_{ij} = \sum_{k=1}^n c_{ijk}\dot{q}_k
\]
with
\[
	c_{ijk} = \frac{1}{2} \left( \frac{\partial b_{ij}}{\partial q_k} + \frac{\partial b_{ik}}{\partial q_j} - \frac{\partial b_{jk}}{\partial q_i} \right)
\]

$c_{ijk}$ are called \textbf{Christoffel symbols}\index{Christoffel symbols} of the first kind

\subsection{The non conservative forces}

The last thing we have to do is include the forces acting on the system expressed as $\matr{\xi}$ in the \autoref{eq:dynamics-generalized-forces}.

We can identify tree types of forces:

\begin{itemize}
	\item joint torques $\vect{\tau}$
	\item viscous friction torques $-\matr{F}_\nu\dq$ \\
		with $\matr{F}_\nu$ a diagonal matrix of viscous friction coefficients
	\item static friction torques $-\matr{f}_s(\q,\dq)$ \\
		with $\matr{f}_s$ function that models the static friction at the joints
\end{itemize}

If we include all these three forces in the \autoref{eq:dynamics-generalized-forces} we get

\begin{equation}
	\matr{B}(\q)\ddq + \matr{C}(\q,\dq)\dq + \matr{F}_\nu\dq + \matr{f}_s(\q,\dq) + \vect{g}(\q) = \vect{\tau} \label{eq:dynamics}
\end{equation}